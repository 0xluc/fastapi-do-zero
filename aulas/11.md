# [WIP] Fazendo deploy no Fly.io e configurando o PostgreSQL

Aula em manutenção. Discussões no tópico de manutenção na issue [#58](https://github.com/dunossauro/fastapi-do-zero/issues/58){:target="_blank"} do repositório.

---

**Objetivos da aula:**

- Entender o que é o Fly.io e como instalar sua CLI
- Aprender a fazer o deploy de uma aplicação Docker no Fly.io
- Configurar uma instância do PostgreSQL no Fly.io
- Configurar as variáveis de ambiente
- Rodar as migrações do Alembic
- Configurar o deploy contínuo no Github Actions

---

Agora que temos uma API criada com integração ao banco de dados e testes sendo executados via integração contínua. Chegou a tão esperada hora de colocar nossa aplicação em produção para que todas as pessoas possam acessá-la. Vamos colocar nossa aplicação em produção usando um serviço de [PaaS](https://pt.wikipedia.org/wiki/Plataforma_como_servi%C3%A7o){:target="_blank"}, chamado [Fly.io](https://fly.io){:target="_blank"}.


## O Fly.io

> Revisar esse tópico!

O Fly.io é uma plataforma de deploy que nos permite lançar nossas aplicações na nuvem e que oferece serviços para diversas linguagens de programação e frameworks como Python e Django, PHP e Laravel, Ruby e Rails, Elixir e Phoenix, etc. Ao mesmo tempo em que permite que o deploy de aplicações em containers docker também possam ser utilizadas, como é o nosso caso.

Além disso, o Fly disponibiliza bancos de dados para serem usados em nossas aplicações, como PostgreSQL e [Redis](https://redis.io/){:target="_blank"}.

O motivo pela escolha do Fly é que ele permite que façamos deploys de aplicações em desenvolvimento / provas de conceito de forma gratuita - o que vamos usar para "colocar nossa aplicação no mundo".

> Para fazer o uso do fly.io é necessário que você [crie uma conta no serviço](https://fly.io/app/sign-in){:target="_blank"}.


### Flyclt

Uma das formas de interagir com a plataforma é via uma aplicação de linha de comando disponibilizada pelo Fly, o [flyctl](https://fly.io/docs/flyctl/){:target="_blank"}.

O flyctl precisa ser instalado em seu computador. Em algumas distribuições linux o flyctl está disponível nos repositórios de aplicações. Para Mac/Windows ou distribuições linux que não contam com o pacote no repositório, você pode seguir o guia de [instalação oficial](https://fly.io/docs/hands-on/install-flyctl/){:target="_blank"}.

Após a instalação, você pode verificar se o flyctl está instalado em seu sistema operacional digitando o seguinte comando no terminal:


```shell title="$ Execução no terminal!"
flyctl version

flyctl v0.1.134 linux/amd64 Commit: ... BuildDate: 2023-12-08T18:58:44Z
```

A versão instalada no meu sistema é a `0.1.134`. No momento da sua instalação, você pode se deparar com uma versão mais recente do que a minha no momento, mas os comandos devem funcionar da mesma forma em qualquer versão menor que `0.2.131`.


#### Fazendo login via terminal

Após a instalação do `flyct` é importante que você efetue o login usando suas credenciais, para que o `flyctl` consiga vincular suas credenciais com a linha de comando. Para isso podemos executar o seguinte comando:

```shell title="$ Execução no terminal!"
flyctl auth login
Opening https://fly.io/app/auth/cli/91283719231023123 ...

Waiting for session...
```

Isso abrirá uma janela em seu browser pedindo que você efetue o login:

![Captura de tela da tela inicial de login do fly.io](assets/11_auth_login_fly.png){: .center .shadow width="500" }

Após inserir suas credenciais, você pode fechar o browser e no shell a execução do comando terminará mostrando a conta em que você está logado:

```shell title="$ Continuação da respota do terminal"
Waiting for session... Done
successfully logged in as <seu-email@de-login.com>
```

Desta forma, toda a configuração necessária para o deploy está pronta!

## Configurações para o deploy


- `fly launch --no-deploy`

### Configuração dos segredos

### Migrations

### Deploy da aplicação


---
> Texto antigo

## O Fly.io e a instalação da CLI

Para iniciar, precisamos instalar a CLI do Fly.io, chamada `flyctl`. Você pode baixá-la no site oficial do Fly.io. Com o `flyctl` instalado, precisamos fazer login na nossa conta do Fly.io usando o comando:

```shell title="$ Execução no terminal!"
fly auth login
```

Este comando irá abrir o navegador para você entrar com suas credenciais do Fly.io.

## Criando a aplicação no Fly.io e fazendo o deploy

Depois de logado, podemos criar uma nova aplicação no Fly.io usando o comando:

```shell title="$ Execução no terminal!"
fly launch
```

Este comando irá perguntar algumas informações sobre sua aplicação e então criará uma nova aplicação no Fly.io. Com nossa aplicação criada, podemos agora fazer o deploy da nossa imagem Docker usando o comando:

```shell title="$ Execução no terminal!"
fly deploy --local-only
```

A opção `--local-only` diz para o `flyctl` construir a imagem Docker localmente e depois fazer o upload dela para o Fly.io.

## Configurando a instância do PostgreSQL no Fly.io

Antes de avançarmos, é importante mencionar uma especificidade do Fly.io: para criar uma instância do PostgreSQL, a plataforma requer que um cartão de crédito seja fornecido. Esta é uma medida de segurança adotada para evitar o uso indevido de seus serviços, como a execução de ferramentas de mineração. Apesar dessa exigência, o serviço de PostgreSQL é oferecido de forma gratuita. Mais detalhes podem ser encontrados [neste artigo](https://fly.io/blog/free-postgres/).

Agora, vamos criar uma instância do PostgreSQL. O Fly.io fornece um serviço PostgreSQL que podemos usar para criar uma nova instância do PostgreSQL com apenas alguns comandos.

## Configurando as variáveis de ambiente e rodando as migrações do Alembic

Com a instância criada, algumas variáveis de ambiente serão automaticamente definidas para nós. Para que o Alembic possa executar as migrações, precisamos configurar a variável `DATABASE_URL` no nosso aplicativo para apontar para a instância do PostgreSQL do Fly.io.

```shell title="$ Execução no terminal!"
fly secrets set DATABASE_URL=<value>
```

Substitua `<value>` pela string de conexão do seu banco de dados PostgreSQL.

Finalmente, podemos executar nossas migrações Alembic. Usaremos a CLI do Fly.io para executar o comando dentro de um contêiner do nosso aplicativo:

```shell title="$ Execução no terminal!"
fly ssh console --app <your-app-name> 'poetry run alembic upgrade head'
```

Substitua `<your-app-name>` pelo nome do seu aplicativo no Fly.io.

## Configurando o deploy contínuo no Github Actions

Agora que temos nosso aplicativo funcionando no Fly.io, podemos configurar o Github Actions para fazer o deploy automático sempre que fizermos um push no nosso repositório. Para isso, precisaremos adicionar alguns passos ao nosso arquivo de pipeline do Github Actions:

```yaml
- name: Build and push Docker image to Fly.io
  run: |
    flyctl deploy --local-only
    flyctl deploy
```

Com isso, nossa aplicação está pronta para uso no Fly.io!

## Conclusão

Ao longo desta aula, nós mergulhamos no mundo do deploy de aplicações com o Fly.io, uma plataforma que facilita imensamente a tarefa de colocar nossas aplicações para funcionar na nuvem. Além disso, também tivemos a chance de entender como gerenciar variáveis de ambiente de forma segura e eficiente, permitindo a nossa aplicação se adaptar a diferentes contextos de execução.

Aprendemos como subir nossa imagem Docker no Fly.io e como este processo pode ser simplificado e automatizado. Também vimos como é possível ter nosso banco de dados rodando no mesmo ambiente da nossa aplicação, facilitando a manutenção e a escalabilidade.

Configuramos e utilizamos o PostgreSQL no Fly.io, o que nos deu uma visão prática de como gerenciar bancos de dados em um ambiente de produção. Ao fazer isso, pudemos integrar ainda mais a nossa aplicação ao ambiente em que ela está rodando.

Além disso, exploramos a importância das migrações e como elas podem ser gerenciadas usando o Alembic, que nos permitiu atualizar nosso banco de dados de forma controlada e rastreável.

Finalmente, vimos como podemos automatizar todo o processo de deploy usando o Github Actions. Esta é uma prática extremamente útil e poderosa, pois permite que a nossa aplicação esteja sempre atualizada com as últimas alterações que fizemos, sem a necessidade de qualquer intervenção manual.

Com todas essas peças, temos agora uma aplicação robusta e pronta para escalar, com todos os elementos necessários para ser operada em um ambiente de produção real. Estas são ferramentas e práticas que estão no coração do desenvolvimento de software moderno, e dominá-las nos permitirá construir aplicações cada vez mais complexas e eficientes.

Na próxima aula, faremos uma recapitulação de tudo o que aprendemos neste curso e discutiremos os próximos passos. Continue acompanhando para fortalecer ainda mais seus conhecimentos em desenvolvimento de aplicações com FastAPI, Docker, CI/CD e muito mais. Até a próxima aula!
