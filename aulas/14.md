# Projeto final

Voc√™ chegou ao final, [PARABAINS](https://youtu.be/1Mcdh2Vf2Xk){:target="_blank"} üéâ

No aprendizado, nada melhor que praticar! Para isso vamos fazer nosso "TCC". A ideia do projeto √© simplesmente para fixa√ß√£o do conte√∫do.

## O projeto

Neste projeto vamos construir uma API que segue os mesmos moldes da que desenvolvemos durante o curso, por√©m, com outra proposta. Iremos fazer uma vers√£o simplificado de um acervo digital de livros. Chamaremos de `MADR` (Mader), uma sigla para "Meu Acervo Digital de Romances".

O objetivo do projeto √© criarmos uma gerenciador de livros e relacionar com seus autores. Tudo isso em um contexto bastante simplificado. Usando somente as funcionalidades que aprendemos no curso.

A implementa√ß√£o ser√° baseada em 3 pilares:

```mermaid
graph
    MADL --> A["Controle de acesso / Gerenciamento de contas"]
	MADL --> B["Gerenciamento de Livros"]
	MADL --> C["Gerenciamento de Romancistas"]
	A --> D["Gerenciamento de contas"]
	D --> Cria√ß√£o
	D --> Atualiza√ß√£o
	A --> G["Acesso via JWT"]
	D --> Dele√ß√£o
	B --> E["CRUD"]
	C --> F["CRUD"]
```

## A API

Dividiremos os endpoits em tr√™s `routers`:

1. `contas`: Gerenciamento de contas e de acesso a API
2. `livros`: Gerenciamento de livros
3. `romancistas`: Gerenciamento de romancistas

### Contas

O router de conta deve ser respons√°vel pelas opera√ß√µes referentes a cria√ß√£o, altera√ß√£o e dele√ß√£o de contas. Os endpoints:

- POST `/conta`: deve ser respons√°vel pela cria√ß√£o de uma nova conta

    - O schema respons√°vel para cria√ß√£o desse endpoint deve ser:
    ```json
    {
        "username": "fausto",
        "email": "fausto@fausto.com",
        "senha": "1234567",
    }
    ```
	- Esses schema deve ser validado com pydantic
	- O retorno para o caso de sucesso deve ser `201` e com o schema de exemplo:
	```json
	{
	    "id": 10,
		"email": "fausto@fausto.com",
		"username": "fausto"
	}
	```
	- A senha deve ser criptografada antes de ser inserida no banco de dados
	- obs: **N√£o √© necess√°rio** fazer o login no sistema para enviar uma requisi√ß√£o para esse enpoint
   	- üö® Caso o registro j√° exista na base, [conflito](#erro-de-conflito)
	- :warning: Antes de inserir no banco, o nome devem ser [sanitizados](#sanitizacao-de-dados)

- PUT `/conta/{id}`: deve ser respons√°vel pela altera√ß√£o de uma conta especificada por `id`
    - O schema respons√°vel para cria√ß√£o desse endpoint deve ser:
    ```json
    {
        "username": "fausto",
        "email": "fausto@fausto.com",
        "senha": "1234567",
    }
    ```
	- Esses schema deve ser validado com pydantic
	- O retorno para o caso de sucesso deve ser `200` e com o schema de exemplo:
	```json
	{
	    "id": 10,
		"email": "fausto@fausto.com",
		"username": "fausto"
	}
	```
	- üö® O acesso s√≥ pode ocorrer via um `Bearer token` v√°lido enviado nos headers, [erro](#erros)
	- üö® Somente a pessoa detentora da sua pr√≥pria conta conta pode alterar seus dados
	- üö® Caso as altera√ß√µes no registro j√° existam na base, [conflito](#erro-de-conflito)
	- :warning: Antes de inserir no banco, o nome devem ser [sanitizados](#sanitizacao-de-dados)

- DELETE `/conta/{id}`: deve ser respons√°vel pela dele√ß√£o de uma conta especificada por `id`
    - O retorno para o caso de sucesso deve ser `200` e com o schema de exemplo:
	```json
	{
		"message": "Conta deletada com sucesso"
	}
	```
	- üö® O acesso s√≥ pode ocorrer via um `Bearer token` v√°lido enviado nos headers, [erro](#erros)
	- üö® Somente a pessoa detentora da sua pr√≥pria conta conta pode alterar seus dados

- POST `/token`: Respons√°vel pelo login
    - O endpoint dever√° receber o seguinte schema via `OAuth2PasswordRequestForm`:
	```json
	{
	    "username": "fausto@fausto.com",
		"password": "12345"
	}
	```
	- O conta deve ser validada com "username" e "password"
	- üö® O acesso s√≥ pode ocorrer via um `Bearer token` v√°lido enviado nos headers, [erro](#erros)
    - O retorno para o caso de sucesso deve ser `200` e com o schema de exemplo:
	```json
	{
		"access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0ZUB0ZXN0LmNvbSIsImV4cCI6MTY5MDI1ODE1M30.Nx0P_ornVwJBH_LLLVrlJoh6RmJeXR-Nr7YJ_mlGY04",
		"token_type": "bearer"
	}
	```

- POST `/refresh-token`: Respons√°vel por atualizar o token
    - O endpoint dever√° receber os headers:
	```json
	{
		"Authorization": " Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0ZUB0ZXN0LmNvbSIsImV4cCI6MTY5MDI1ODE1M30.Nx0P_ornVwJBH_LLLVrlJoh6RmJeXR-Nr7YJ_mlGY04"
	}
	```
    - O retorno para o caso de sucesso deve ser `200` e com o schema de exemplo:
	```json
	{
		"access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0ZUB0ZXN0LmNvbSIsImV4cCI6MTY5MDI1ODE1M30.Nx0P_ornVwJBH_LLLVrlJoh6RmJeXR-Nr7YJ_mlGY04",
		"token_type": "bearer"
	}
	```
	- üö® Caso as coisas n√£o ocorram como o esperado: [Erros](#erros)

##### As condi√ß√µes do token JWT

O tempo de expira√ß√£o do token deve ser de `60` minutos, o algor√≠timo usado deve ser `HS256` e o subject deve ser o `email`.

### Livros

- POST `/livro`: Respons√°vel pela adi√ß√£o de um livro no MADR
	- O livro deve ser criado com base no seguinte schema:
	```json
	{
		"ano": 1973,
		"titulo": "Caf√© Da Manh√£ Dos Campe√µes",
		"id_romancista": 42
	}
	```
    - :warning: Dispon√≠vel somente via autentica√ß√£o, caso contr√°rio [erro](#erros-de-permissao)
	- :warning: Antes de inserir no banco, os nomes devem ser [sanitizados](#sanitizacao-de-dados)
	- üö® Caso o novo nome j√° exista na base, [conflito](#erro-de-conflito)
- DELETE `/livro/{id}`:
    - :warning: Dispon√≠vel somente via autentica√ß√£o, caso contr√°rio [erro](#erros-de-permissao)
	- üö® Caso o `id` n√£o exista no MADR, [erro](#erro-nao-encontrado)
- PATCH `/livro/{id}`:
    - :warning: Dispon√≠vel somente via autentica√ß√£o, caso contr√°rio [erro](#erros-de-permissao)
	- :warning: Antes de inserir no banco, os nomes devem ser [sanitizados](#sanitizacao-de-dados)
	- üö® Caso o `id` n√£o exista no MADR, [erro](#erro-nao-encontrado)
	- üö® Caso o novo nome j√° exista na base, [conflito](#erro-de-conflito)
- GET `/livro?`: TODO: filtros

### Romancistas

- POST `/romancista`: Respons√°vel pela adi√ß√£o de romancistas no MADR
	- Romancista devem ser criadas com base no seguinte schema:
	```json
	{
		"nome": "Clarice Lispector"
	}
	```
	- A resposta padr√£o deve retornar `201` com o schema:
	```json
	{
		"id": 42,
		"nome": "Clarice Lispector"
	}
	```
    - :warning: Dispon√≠vel somente via autentica√ß√£o, caso contr√°rio [erro](#erros-de-permissao)
	- :warning: Antes de inserir no banco, os nomes devem ser [sanitizados](#sanitizacao-de-dados)
	- üö® Caso o novo nome j√° exista na base, [conflito](#erro-de-conflito)

- DELETE `/romancista/{id}`: respons√°vel pela dele√ß√£o de romancistas por `id`
    - O retorno para o caso de sucesso deve ser `200` e com o schema de exemplo:
	```json
	{
		"message": "Romancista deletada no MADR"
	}
	```
    - :warning: Dispon√≠vel somente via autentica√ß√£o, caso contr√°rio [erro](#erros-de-permissao)
	- üö® Caso o `id` n√£o exista no MADR, [erro](#erro-nao-encontrado)

- PATCH `/romancista/{id}`: respons√°vel pela altera√ß√£o de romancistas por `id`
	- Romancista devem ser alteradas com base no seguinte schema:
	```json
	{
		"nome": "Clarice Lispector"
	}
	```
	- A resposta padr√£o deve retornar `200` com o schema:
	```json
	{
		"id": 42,
		"nome": "Clarice Lispector"
	}
	```
    - :warning: Dispon√≠vel somente via autentica√ß√£o, caso contr√°rio [erro](#erros-de-permissao)
	- :warning: Antes de inserir no banco, os nomes devem ser [sanitizados](#sanitizacao-de-dados)
	- üö® Caso o `id` n√£o exista no MADR, [erro](#erro-nao-encontrado)
	- üö® Caso o novo nome j√° exista na base, [conflito](#erro-de-conflito)

- GET `/romancista?`: TODO: filtros

### Sanitiza√ß√£o de dados

Antes de inserir no banco, os nomes de romancistas ou livros devem ser sanitizados.

Exemplos para os nomes:

| Entrada                                                               | Sanitizado       |
|-----------------------------------------------------------------------|------------------|
| "Machado de Assis"                                                    | machado de assis |
| "Manuel&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Bandeira"      | manuel bandeira  |
| "Edgar Alan Poe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"| edgar alan poe   |
| "Androides Sonham Com Ovelhas El√©tricas?"                             | androides sonham com ovelhas el√©tricas   |
| "&nbsp;&nbsp;breve &nbsp;hist√≥ria &nbsp;do tempo&nbsp;" | breve hist√≥ria do tempo |
| "O mundo assombrado pelos dem√¥nios" | o mundo assombrado pelos dem√¥nios |


### Erros

#### Erros de autentica√ß√£o

Todos os erros relativos a autentica√ß√£o devem retornar o status code `400 BAD REQUEST` com o seguinte schema:

```json
{
    "message": "Email ou senha incorretos"
}
```

#### Erros de permiss√£o

Caso uma pessoa tente fazer uma opera√ß√£o sem a permiss√£o necess√°ria, o status code`401 Unauthorized` dever√° ser retornado com o json:

```json
{
    "message": "N√£o autorizado"
}
```

#### Erro n√£o encontrado

Caso o `id` n√£o exista no MADR, um erro `404 NOT FOUND` deve ser retornado com o json:

```json
{
	"message": "Romancista n√£o consta no MADR"
}
```

ou ent√£o

```json
{
	"message": "Livro n√£o consta no MADR"
}
```

#### Erro de conflito

Caso o recurso j√° exista devemos retornar `409 CONFLICT` com o json:

```json
{
	"message": "{recurso} j√° consta no MADR"
}
```

Onde a vari√°vel `recurso` √© relativa ao recurso que est√° duplicado. Exemplos para:

- contas: `"conta j√° consta no MADR"`
- livros: `"livro j√° consta no MADR"`
- romancista: `"romancista j√° consta no MADR"`


## O banco de dados / ORM

Tr√™s tabelas devem ser criadas, `User`, `Livro` e `Romancista`. Onde `Livro` e `Romancista` se relacionam da forma que um autor pode estar relacionado a diversos livros e diversos livros devem ser associados a uma √∫nica romancista. Como sugere o [DER](https://pt.wikipedia.org/wiki/Modelo_entidade_relacionamento){:target="_blank"}:

```mermaid
erDiagram
  Romancista |o -- |{ Livro : livros
  User {
      int id PK
      string email UK
	  string username UK
	  string senha
  }
  Livro {
	  int id  PK
	  string ano
	  string titulo UK
      string id_romancista FK
  }
  Romancista {
      int id PK
      string nome UK
	  string livros
  }
```

### Relacionamentos no ORM

```python
class Livro:
	...

	autoria: Mapped[Romancista] = relationship(
        init=False, back_populates='livros'
    )

class Romancista:
	...

    livros: Mapped[list['Livro']] = relationship(
        init=False, back_populates='romancista', cascade='all, delete-orphan'
    )
```

## Cen√°rios de teste

### Gerenciamento de contas

=== "Cria√ß√£o de contas"
	```gherkin
	Funcionalidade: Gerenciamento de conta

	Cen√°rio: Cria√ß√£o de conta
		Quando enviar um "POST" em "/user"
		"""
		{
			"username": "dunossauro",
			"email": "dudu@dudu.com",
			"password": "123456"
		}
		"""
		Ent√£o devo receber o status "201"
		E o json contendo
		"""
		{
			"email": "dudu@dudu.com",
			"username": "dunossauro"
		}
		"""

	Cen√°rio: Altera√ß√£o de conta
		Quando enviar um "POST" em "/user"
		"""
		{
			"username": "dunossauro",
			"email": "dudu@dudu.com",
			"password": "123456"
		}
		"""
		Quando enviar um "PUT" em "/user/1"
		"""
		{
			"username": "dunossauro",
			"email": "dudu@dudu.com",
			"password": "654321"
		}
		"""
		Ent√£o devo receber o status "200"
		E o json contendo
		"""
		{
			"username": "dunossauro",
			"email": "dudu@dudu.com"
		}
		"""

	Cen√°rio: Dele√ß√£o da conta
		Quando enviar um "POST" em "/user"
		"""
		{
			"username": "dunossauro",
			"email": "dudu@dudu.com",
			"password": "123456"
		}
		"""
		Quando enviar um "DELETE" em "/user/1"
		Ent√£o devo receber o status "200"
		E o json contendo
		"""
		{
			"message": "Conta deletada com sucesso"
		}
		"""
	```

=== "Casos de erro"
	```gherkin
	Cen√°rio: Cria√ß√£o de conta j√° existente
		Quando enviar um "POST" em "/user"
		"""
		{
			"username": "dunossauro",
			"email": "dudu@dudu.com",
			"password": "123456"
		}
		"""
		Quando enviar um "POST" em "/user"
		"""
		{
			"username": "dunossauro",
			"email": "dudu@dudu.com",
			"password": "123456"
		}
		"""
		Ent√£o devo receber o status "400"
		E o json contendo
		"""
		{
			"message": "Conta j√° cadastrada"
		}
		"""
	```

=== "Autentica√ß√£o e autoriza√ß√£o"
	```gherkin
	TODO
	```


### Gerenciamento de livros

TODO

### Gerenciamento de romancistas

TODO
